<script>
// Pastikan URL ini sama persis dengan yang ada di kmeans.js / admin.html
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw2AHLZs3KVqr_v99_oSH-Oy5zHUtEH3_y-tfBt_305weCdCXf5AxqDkGN1spqsvwO/exec";

// --- VALIDASI MULTIPLE SELECT ---
document.querySelectorAll('.grid[data-max]').forEach(container => {
    const max = parseInt(container.dataset.max);
    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
    
    // PERBAIKAN: Identifikasi elemen error secara spesifik berdasarkan nama checkbox
    const checkboxName = checkboxes[0] ? checkboxes[0].name : null;
    let errorElement = null;
    if (checkboxName) {
        // Asumsi ID error adalah [nama]-error (misal: kategori_konten-error)
        errorElement = document.getElementById(`${checkboxName}-error`);
    }

    if (!errorElement) {
        console.error(`Error element not found for checkbox group: ${checkboxName}`);
        return; // Hentikan jika elemen error tidak ditemukan
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checkedCount = Array.from(checkboxes).filter(c => c.checked).length;
            if (checkedCount > max) {
                checkbox.checked = false;
                errorElement.textContent = `Pilih maksimal ${max} kategori saja.`;
                errorElement.classList.remove('hidden');
                setTimeout(() => errorElement.classList.add('hidden'), 2000);
            }
        });
    });
});
// --------------------------------

document.getElementById("survey-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const btn = form.querySelector("button[type='submit']");
  const originalBtnText = btn.innerHTML;
  const status = document.getElementById("status");

  // --- VALIDASI MULTIPLE SELECT SAAT SUBMIT ---
  const kategoriCheckboxes = form.querySelectorAll('input[name="kategori_konten"]:checked');
  const sifatCheckboxes = form.querySelectorAll('input[name="sifat_video"]:checked');
  
  // Perbaikan validasi menggunakan getElementById secara langsung:
  const kategoriError = document.getElementById("kategori_konten-error");
  const sifatError = document.getElementById("sifat_video-error");

  // Reset pesan error
  kategoriError.classList.add('hidden');
  sifatError.classList.add('hidden');
  
  if (kategoriCheckboxes.length === 0 || kategoriCheckboxes.length > 3) {
      kategoriError.textContent = "Anda harus memilih 1-3 kategori konten.";
      kategoriError.classList.remove('hidden');
      return;
  }
  
  if (sifatCheckboxes.length === 0 || sifatCheckboxes.length > 2) {
      sifatError.textContent = "Anda harus memilih 1-2 sifat video.";
      sifatError.classList.remove('hidden');
      return;
  }
  // ---------------------------------------------

  // UI Loading State
  btn.disabled = true;
  btn.innerHTML = "⏳ Mengirim...";
  status.textContent = "";
  status.className = "text-center text-sm font-medium text-blue-600 mt-4";

  try {
    const data = {};
    
    // Khusus untuk checkbox, ambil semua nilai dalam bentuk array
    data.kategori_konten = Array.from(kategoriCheckboxes).map(c => c.value);
    data.sifat_video = Array.from(sifatCheckboxes).map(c => c.value);

    // Ambil data select
    data.durasi_video = form.elements['durasi_video'].value;
    data.format_video = form.elements['format_video'].value;
    
    await fetch(APPS_SCRIPT_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "submit", data })
    });

    // Sukses
    status.textContent = "✅ Terima kasih! Jawaban Anda telah tersimpan.";
    status.className = "text-center text-sm font-bold text-green-600 mt-4";
    form.reset();

  } catch (err) {
    console.error(err);
    status.textContent = "❌ Gagal mengirim. Periksa koneksi internet Anda.";
    status.className = "text-center text-sm font-bold text-red-600 mt-4";
  } finally {
    // Kembalikan tombol ke semula setelah 2 detik
    setTimeout(() => {
      btn.disabled = false;
      btn.innerHTML = originalBtnText;
    }, 2000);
  }
});
</script>
